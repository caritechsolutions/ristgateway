<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RIST Transcoder Statistics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        .chart-container {
            height: 240px;
            position: relative;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e5e7eb;
            overflow: hidden;
        }
        .progress-value {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold" id="transcoderTitle">Transcoder Statistics</h1>
            <div class="space-x-4">
                <span id="statusBadge" class="status-badge bg-gray-100 text-gray-800">Initializing...</span>
                <a href="/" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Back</a>
            </div>
        </div>

        <!-- Overview Card -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Transcoder Overview</h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Status</p>
                        <p id="status" class="text-2xl font-bold p-1 rounded">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Uptime</p>
                        <p id="uptime" class="text-2xl font-bold">-</p>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold mb-2">Codec Configuration</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Input Format</p>
                        <p id="input_format" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Output Format</p>
                        <p id="output_format" class="text-xl font-bold">-</p>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold mb-2">Stream Information</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Video PID</p>
                        <p id="video_pid" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Audio PID</p>
                        <p id="audio_pid" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Resolution</p>
                        <p id="resolution" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Framerate</p>
                        <p id="framerate" class="text-xl font-bold">-</p>
                    </div>
                </div>
            </div>

            <!-- Bitrate Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Bitrate</h2>
                <div class="chart-container">
                    <canvas id="bitrateChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Input Bitrate</p>
                        <p id="input_bitrate" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Output Bitrate</p>
                        <p id="output_bitrate" class="text-xl font-bold">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- A/V Sync, Performance, Buffering -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- A/V Sync -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">A/V Sync</h2>
                <div class="p-4 bg-gray-50 rounded mb-4">
                    <p class="text-sm text-gray-600">Current Drift</p>
                    <p id="av_drift" class="text-2xl font-bold">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <p class="text-sm text-gray-600">Maximum Drift</p>
                    <p id="av_max_drift" class="text-2xl font-bold">-</p>
                </div>
            </div>
            
            <!-- Performance Metrics -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Performance</h2>
                <div class="p-4 bg-gray-50 rounded mb-2">
                    <p class="text-sm text-gray-600">CPU Usage</p>
                    <div class="flex items-center">
                        <p id="cpu_usage" class="text-xl font-bold mr-2">-</p>
                        <div class="w-full progress-bar">
                            <div id="cpu_bar" class="progress-value bg-blue-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded mb-2">
                    <p class="text-sm text-gray-600">Memory Usage</p>
                    <div class="flex items-center">
                        <p id="memory_usage" class="text-xl font-bold mr-2">-</p>
                        <div class="w-full progress-bar">
                            <div id="memory_bar" class="progress-value bg-green-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <p class="text-sm text-gray-600">Encoding</p>
                    <p id="encoding_fps" class="text-xl font-bold">-</p>
                </div>
            </div>
            
            <!-- Buffer Configuration -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Buffer Configuration</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Buffer Mode</p>
                        <p id="buffer_mode" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Leaky Mode</p>
                        <p id="leaky_mode" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Buffer Size</p>
                        <p id="buffer_size" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Buffer Time</p>
                        <p id="buffer_time" class="text-xl font-bold">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buffer Levels -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Queue Levels</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Video Input Queue -->
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Video Input Queue</h3>
                    <div class="progress-bar mb-2">
                        <div id="video_input_bar" class="progress-value bg-blue-500" style="width: 0%"></div>
                    </div>
                    <div class="text-sm">
                        <p>Level: <span id="video_input_percent">0%</span></p>
                        <p>Underflows: <span id="video_input_underflows">0</span></p>
                        <p>Overflows: <span id="video_input_overflows">0</span></p>
                    </div>
                </div>
                <!-- Audio Input Queue -->
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Audio Input Queue</h3>
                    <div class="progress-bar mb-2">
                        <div id="audio_input_bar" class="progress-value bg-green-500" style="width: 0%"></div>
                    </div>
                    <div class="text-sm">
                        <p>Level: <span id="audio_input_percent">0%</span></p>
                        <p>Underflows: <span id="audio_input_underflows">0</span></p>
                        <p>Overflows: <span id="audio_input_overflows">0</span></p>
                    </div>
                </div>
                <!-- Video Output Queue -->
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Video Output Queue</h3>
                    <div class="progress-bar mb-2">
                        <div id="video_output_bar" class="progress-value bg-indigo-500" style="width: 0%"></div>
                    </div>
                    <div class="text-sm">
                        <p>Level: <span id="video_output_percent">0%</span></p>
                        <p>Underflows: <span id="video_output_underflows">0</span></p>
                        <p>Overflows: <span id="video_output_overflows">0</span></p>
                    </div>
                </div>
                <!-- Audio Output Queue -->
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Audio Output Queue</h3>
                    <div class="progress-bar mb-2">
                        <div id="audio_output_bar" class="progress-value bg-purple-500" style="width: 0%"></div>
                    </div>
                    <div class="text-sm">
                        <p>Level: <span id="audio_output_percent">0%</span></p>
                        <p>Underflows: <span id="audio_output_underflows">0</span></p>
                        <p>Overflows: <span id="audio_output_overflows">0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Frames and Packets -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Frame Statistics -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Frame Statistics</h2>
                <div class="grid grid-cols-3 gap-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Processed</p>
                        <p id="frames_processed" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Dropped</p>
                        <p id="frames_dropped" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Delayed</p>
                        <p id="frames_delayed" class="text-xl font-bold">-</p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-1">Timestamp Status</p>
                    <div id="timestamp_status" class="p-2 rounded bg-gray-100">
                        <p>PTS Discontinuity: <span id="pts_discontinuity">No</span></p>
                        <p>Gap Size: <span id="timestamp_gap">0 ms</span></p>
                    </div>
                </div>
            </div>

            <!-- Packet Statistics -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Packet Statistics</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Input Packets</p>
                        <p id="input_packets" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Output Packets</p>
                        <p id="output_packets" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Input Jitter</p>
                        <p id="input_jitter" class="text-xl font-bold">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded">
                        <p class="text-sm text-gray-600">Output Jitter</p>
                        <p id="output_jitter" class="text-xl font-bold">-</p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600 mb-1">Network Status</p>
                    <div id="network_status" class="p-2 rounded bg-gray-100">
                        <p>Stability: <span id="network_stable">-</span></p>
                        <p>Avg Packet Size: <span id="avg_packet_size">-</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.protocol}//${window.location.hostname}:5000`;
        const transcoderId = new URLSearchParams(window.location.search).get('channel');
        let bitrateChart;
        const maxDataPoints = 30;
        const bitrateData = {
            input: [],
            output: []
        };
        const timeLabels = [];

        function formatBitrate(bps) {
            const value = typeof bps === 'number' ? bps : parseFloat(bps);
            
            if (value >= 1000) return (value / 1000).toFixed(2) + ' Mbps';
            return value.toFixed(2) + ' Kbps';
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function updateStatusDisplay(status) {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('status');
            
            if (status === 'running') {
                statusBadge.className = 'status-badge bg-green-100 text-green-800';
                statusBadge.textContent = 'Running';
                statusText.className = 'text-2xl font-bold p-1 rounded bg-green-100 text-green-800';
                statusText.textContent = 'Running';
            } else if (status === 'stopped') {
                statusBadge.className = 'status-badge bg-gray-100 text-gray-800';
                statusBadge.textContent = 'Stopped';
                statusText.className = 'text-2xl font-bold p-1 rounded bg-gray-100 text-gray-800';
                statusText.textContent = 'Stopped';
            } else {
                statusBadge.className = 'status-badge bg-red-100 text-red-800';
                statusBadge.textContent = 'Error';
                statusText.className = 'text-2xl font-bold p-1 rounded bg-red-100 text-red-800';
                statusText.textContent = 'Error';
            }
        }

        function formatMs(ms) {
            if (Math.abs(ms) < 1) {
                return `${(ms * 1000).toFixed(2)} Âµs`;
            }
            return `${ms.toFixed(2)} ms`;
        }

        function updateProgressBar(elementId, value, maxValue = 100) {
            const percent = Math.min(100, Math.max(0, (value / maxValue) * 100));
            const element = document.getElementById(elementId);
            if (element) {
                element.style.width = `${percent}%`;
                
                // Change color based on level
                if (percent > 90) {
                    element.className = 'progress-value bg-red-500';
                } else if (percent > 70) {
                    element.className = 'progress-value bg-yellow-500';
                }
            }
        }

        function updateStats(metrics) {
            // Update status
            updateStatusDisplay(metrics.status);
            
            // Update uptime
            document.getElementById('uptime').textContent = formatUptime(metrics.uptime);
            
            // Update bitrates
            document.getElementById('input_bitrate').textContent = formatBitrate(metrics.input_bitrate_mbps * 1000);
            document.getElementById('output_bitrate').textContent = formatBitrate(metrics.output_bitrate_mbps * 1000);
            
            // Update codec info
            if (metrics.processing && metrics.processing.stream_info) {
                document.getElementById('input_format').textContent = metrics.processing.stream_info.video_codec || 'Unknown';
            }
            document.getElementById('output_format').textContent = metrics.video_codec || 'Unknown';
            
            // Update stream info
            if (metrics.processing && metrics.processing.stream_info) {
                const streamInfo = metrics.processing.stream_info;
                document.getElementById('video_pid').textContent = streamInfo.video_pid || '-';
                document.getElementById('audio_pid').textContent = streamInfo.audio_pid || '-';
            }
            
            // Update resolution and framerate from processing.stream_info
            if (metrics.processing && metrics.processing.stream_info) {
                const streamInfo = metrics.processing.stream_info;
                
                // Check for resolution in stream_info
                if (streamInfo.resolution) {
                    document.getElementById('resolution').textContent = streamInfo.resolution;
                } else {
                    document.getElementById('resolution').textContent = 'Unknown';
                }
                
                // Check for framerate in stream_info
                if (streamInfo.framerate) {
                    document.getElementById('framerate').textContent = `${streamInfo.framerate.toFixed(2)} fps`;
                } else {
                    document.getElementById('framerate').textContent = 'Unknown';
                }
            }
            
            // Update performance metrics
            if (metrics.processing) {
                const cpuUsage = metrics.processing.cpu_usage_percent;
                document.getElementById('cpu_usage').textContent = `${cpuUsage.toFixed(1)}%`;
                updateProgressBar('cpu_bar', cpuUsage, 100);
                
                const memoryUsage = metrics.processing.memory_usage_mb || (metrics.processing.memory_usage_bytes / 1024 / 1024);
                document.getElementById('memory_usage').textContent = `${memoryUsage.toFixed(1)} MB`;
                updateProgressBar('memory_bar', memoryUsage, 1000); // Assuming 1GB is maximum
                
                document.getElementById('encoding_fps').textContent = 
                    `${metrics.processing.video_encoding_fps.toFixed(1)} fps`;
            }
            
            // Update AV sync info
            if (metrics.processing && metrics.processing.av_sync) {
                const avSync = metrics.processing.av_sync;
                document.getElementById('av_drift').textContent = formatMs(avSync.current_drift_ms);
                document.getElementById('av_max_drift').textContent = formatMs(avSync.max_drift_ms);
            }
            
            // Update frame statistics
            if (metrics.processing) {
                document.getElementById('frames_processed').textContent = 
                    metrics.processing.frames_processed.toLocaleString();
                document.getElementById('frames_dropped').textContent = 
                    metrics.processing.frames_dropped.toLocaleString();
                document.getElementById('frames_delayed').textContent = 
                    metrics.processing.frames_delayed.toLocaleString();
                
                document.getElementById('pts_discontinuity').textContent = 
                    metrics.processing.pts_discontinuity ? 'Yes' : 'No';
                document.getElementById('timestamp_gap').textContent = 
                    formatMs(metrics.processing.timestamp_gap_ms || 0);
                
                if (metrics.processing.pts_discontinuity) {
                    document.getElementById('timestamp_status').className = 'p-2 rounded bg-yellow-100';
                } else {
                    document.getElementById('timestamp_status').className = 'p-2 rounded bg-green-100';
                }
            }
            
            // Update packet statistics
            if (metrics.network) {
                document.getElementById('input_packets').textContent = 
                    metrics.network.input_packets.toLocaleString();
                document.getElementById('output_packets').textContent = 
                    metrics.network.output_packets.toLocaleString();
                document.getElementById('input_jitter').textContent = 
                    formatMs(metrics.network.input_jitter_ms);
                document.getElementById('output_jitter').textContent = 
                    formatMs(metrics.network.output_jitter_ms);
                
                document.getElementById('network_stable').textContent = 
                    metrics.network.network_stable ? 'Stable' : 'Unstable';
                document.getElementById('avg_packet_size').textContent = 
                    `${metrics.network.avg_packet_size_bytes.toFixed(0)} bytes`;
                
                if (metrics.network.network_stable) {
                    document.getElementById('network_status').className = 'p-2 rounded bg-green-100';
                } else {
                    document.getElementById('network_status').className = 'p-2 rounded bg-red-100';
                }
            }
            
            // Update queue levels
            if (metrics.input_video_queue) {
                const vq = metrics.input_video_queue;
                document.getElementById('video_input_percent').textContent = `${vq.percent_full.toFixed(1)}%`;
                updateProgressBar('video_input_bar', vq.percent_full);
            }
            
            if (metrics.input_audio_queue) {
                const aq = metrics.input_audio_queue;
                document.getElementById('audio_input_percent').textContent = `${aq.percent_full.toFixed(1)}%`;
                updateProgressBar('audio_input_bar', aq.percent_full);
            }
            
            if (metrics.output_queue) {
                const voq = metrics.output_queue;
                document.getElementById('video_output_percent').textContent = `${voq.percent_full.toFixed(1)}%`;
                updateProgressBar('video_output_bar', voq.percent_full);
            }
            
            if (metrics.audio_output_queue) {
                const aoq = metrics.audio_output_queue;
                document.getElementById('audio_output_percent').textContent = `${aoq.percent_full.toFixed(1)}%`;
                updateProgressBar('audio_output_bar', aoq.percent_full);
            }
            
            // Fetch buffer stats to update underflow/overflow counters
            fetchBufferStats();
            
            // Update chart data
            const now = new Date().toLocaleTimeString();
            timeLabels.push(now);
            
            // Get bitrate in Mbps for the chart
            let inputMbps = metrics.input_bitrate_mbps || 0;
            let outputMbps = metrics.output_bitrate_mbps || 0;
            
            bitrateData.input.push(inputMbps);
            bitrateData.output.push(outputMbps);
            
            if (timeLabels.length > maxDataPoints) {
                timeLabels.shift();
                bitrateData.input.shift();
                bitrateData.output.shift();
            }
            
            if (bitrateChart) {
                bitrateChart.data.labels = timeLabels;
                bitrateChart.data.datasets[0].data = bitrateData.input;
                bitrateChart.data.datasets[1].data = bitrateData.output;
                bitrateChart.update();
            }
        }

        function fetchBufferStats() {
            fetch(`${API_BASE}/transcoders/${transcoderId}/buffers`, {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(bufferData => {
                if (bufferData) {
                    // Update buffer configuration if present
                    if (bufferData.configuration) {
                        document.getElementById('buffer_mode').textContent = bufferData.configuration.buffer_mode;
                        document.getElementById('leaky_mode').textContent = bufferData.configuration.leaky_mode;
                        document.getElementById('buffer_size').textContent = `${bufferData.configuration.buffer_size_mb} MB`;
                        document.getElementById('buffer_time').textContent = `${bufferData.configuration.buffer_time_ms} ms`;
                    }
                    
                    // Update queue stats
                    if (bufferData.queues) {
                        const { queues } = bufferData;
                        
                        // Update video input queue
                        if (queues.video_input) {
                            document.getElementById('video_input_underflows').textContent = 
                                queues.video_input.underflows.toLocaleString();
                            document.getElementById('video_input_overflows').textContent = 
                                queues.video_input.overflows.toLocaleString();
                        }
                        
                        // Update audio input queue
                        if (queues.audio_input) {
                            document.getElementById('audio_input_underflows').textContent = 
                                queues.audio_input.underflows.toLocaleString();
                            document.getElementById('audio_input_overflows').textContent = 
                                queues.audio_input.overflows.toLocaleString();
                        }
                        
                        // Update video output queue
                        if (queues.video_output) {
                            document.getElementById('video_output_underflows').textContent = 
                                queues.video_output.underflows.toLocaleString();
                            document.getElementById('video_output_overflows').textContent = 
                                queues.video_output.overflows.toLocaleString();
                        }
                        
                        // Update audio output queue
                        if (queues.audio_output) {
                            document.getElementById('audio_output_underflows').textContent = 
                                queues.audio_output.underflows.toLocaleString();
                            document.getElementById('audio_output_overflows').textContent = 
                                queues.audio_output.overflows.toLocaleString();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching buffer stats:', error);
            });
        }

        function initCharts() {
            const bitrateCtx = document.getElementById('bitrateChart').getContext('2d');
            bitrateChart = new Chart(bitrateCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Input',
                            data: bitrateData.input,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0
                        },
                        {
                            label: 'Output',
                            data: bitrateData.output,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Mbps'
                            }
                        },
                        x: {
                            display: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 6
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} Mbps`;
                                }
                            }
                        }
                    },
                    animation: false
                }
            });
        }

        async function loadTranscoderInfo() {
            try {
                const response = await fetch(`${API_BASE}/transcoders/${transcoderId}`);
                if (!response.ok) throw new Error('Failed to load transcoder info');
                const transcoder = await response.json();
                document.getElementById('transcoderTitle').textContent = `${transcoder.name} Statistics`;
                
                // Set initial values for buffer configuration
                if (transcoder.buffer_settings) {
                    document.getElementById('buffer_size').textContent = `${transcoder.buffer_settings.buffer_size_mb || 1} MB`;
                    document.getElementById('buffer_time').textContent = `${transcoder.buffer_settings.buffer_time_ms || 1000} ms`;
                }
            } catch (error) {
                console.error('Error loading transcoder info:', error);
            }
        }

        async function updateMetrics() {
            try {
                const response = await fetch(`${API_BASE}/transcoders/${transcoderId}/metrics`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch metrics');
                const metrics = await response.json();
                updateStats(metrics);
            } catch (error) {
                console.error('Error fetching metrics:', error);
                updateStatusDisplay('error');
            }
        }

        async function init() {
            try {
                await loadTranscoderInfo();
                initCharts();
                await updateMetrics();
                
                // Poll for metrics every second
                setInterval(updateMetrics, 1000);
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
